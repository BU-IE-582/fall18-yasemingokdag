---
title: "IE582_HW2"
author: "Yasemin Gokdag"
date: "October 25, 2018"
output: html_document

---

```{r setup, include=FALSE, echo= FALSE , eval = TRUE}
require(data.table)
require(anytime)
require(ggplot2)

#read match data
matchdata <- readRDS('C:/Users/yasemin/Desktop/School/IE582/HWs/2/df9b1196-e3cf-4cc7-9159-f236fe738215_matches_2010.rds', refhook = NULL)
matchdata <- as.data.table(matchdata)

#read 
odds <- readRDS('C:/Users/yasemin/Desktop/School/IE582/HWs/2/df9b1196-e3cf-4cc7-9159-f236fe738215_odd_details_2010.rds', refhook = FALSE)
odds <- as.data.table(odds)
```

## Data Cleaning and Setup

Similar to previous task, odds and match data and required libraries are loaded. The codes are not provided since it is exactly the same as the previous setup part 

Data uploaded is examined to see if there is any duplicate records exist, match data has duplicate values, odds data doesn't have any. These duplicate values are removed, and match and odds data are merged. After each step, columns that will not be needed are removed from data table to avoid complexity 

```{r data cleaning match, include= TRUE, echo= TRUE, eval= TRUE, results = FALSE}
#Check for uniqueness of the data.
matchdata <- matchdata[, idCount := 1:.N, list(matchId)]
match_duplicates <- nrow(matchdata[idCount > 1])
```

```{r duplicate match , include= TRUE, echo= FALSE, eval= TRUE, results = TRUE }
print( paste0(match_duplicates, " rows are duplciate" ))
```

data is not unique, remove duplicates and check for uniqueness in odd data 

``` {r data cleanin odds and merge, include= TRUE, echo= TRUE, eval= TRUE, results = FALSE  }
#remove columns that are not necessary, get unique entries 
matchdata <- matchdata[,-c( "idCount"), with=F]
matchdata <- unique(matchdata)
#Repeat for odds
odds <- odds[, rank := 1:.N, list(matchId,betType,oddtype,bookmaker,date,totalhandicap)]
odds[rank > 1]
#empty data table. There is no duplicate records, so data on odss data table is unique,
#we can join two data tables now. 

odds <- odds[,-c( "rank"), with=F] #remove columns that are not necessary 
#merge data, inner join
oddsandmatch <- merge(odds,matchdata, by.x= 'matchId' , by.y = 'matchId' , all.x = FALSE, all.y =  FALSE )
#make sure that resulting table is a data table 
oddsandmatch <- as.data.table(oddsandmatch)

#we get rid of leagueId  and type since there is no information 
oddsandmatch <- oddsandmatch[,-c("leagueId","type"), with=F]
setnames(oddsandmatch, 'date.x', 'oddDate')
setnames(oddsandmatch, 'date.y', 'matchDate')
```

After obtaining merged data, we perform date transformations, remove matches that are not played yet and obtain final bets 

```{r final bets, include= TRUE, echo=TRUE, eval = TRUE, results= FALSE }
#Transform date
oddsandmatch[,oddDateTime := anytime(oddDate)]
#Since we will work on both odds and match outcomes, we should only consider actualized games. 
oddsandmatch <- oddsandmatch[!is.na(score)]
#get final bets
finalbets <- oddsandmatch[order(-oddDateTime), rank := 1:.N, list(bookmaker, betType, oddtype, matchId, totalhandicap)]
finalbets <- finalbets[rank == 1 ]
```

```{r remove_col_1 , include= FALSE, eval = TRUE}
oddsandmatch <- oddsandmatch[,-c( "rank"), with=F]
finalbets <- finalbets[,-c("rank"), with = F] 
```

Bookmakers are selected based on distinct count of matches that they offer odds, and other bookmakers' data is removed. Detailed codes can be found on *Appendix* 

Below are the selected bookmakers 

```{r select bookmaker, include=FALSE, eval = TRUE}
#Now we  reduce the number of selected bookmakers to 8 based on count of distinct games that they offered odds
match_count <- finalbets[, list(Count = length(unique(matchId))), by = c("bookmaker")]
BookmakersSelected <- match_count[order(-Count), head(.SD,8)]$bookmaker
BookmakersSelected <- as.data.table(BookmakersSelected)

finalbets_filtered <- merge(finalbets, BookmakersSelected , by.x = 'bookmaker', by.y = 'BookmakersSelected', all.x = FALSE, all.y = FALSE)
finalbets_filtered <- as.data.table(finalbets_filtered)
```

```{r Bookmakers, include=TRUE, echo= FALSE, eval = TRUE}
print(BookmakersSelected)
```

Odds are transformed into probabilites so that all of them would be in 0-1 interval. 

```{r prob_calc, include = FALSE ,eval = TRUE}
finalbets_filtered[, p1 := 1/odd ]
finalbets_filtered[ , probsum := sum(p1), by = list(bookmaker, matchId, betType, totalhandicap)]
finalbets_filtered[, probability := p1/probsum ]
```

Then, over labels are assigned based on actual match scores with total handicap 2.5.
Label EndResult is a binary variable that takes value 1 if total score > 2.5, and 0 otherwise. 

Home-Tie-Away labels are assigned, HTAResults takes value 1 if home wins, 2 if away wins and 0 if tie.

Detailed codes can be found in *Appendix* 

Also, I removed all information related to "Asian Handicap" bets, because the variety caused by its handicaps is too much and honestly I could not understand how it works, so I won't be able to comment on it. 

```{r  actual over, include=FALSE, eval = TRUE}
#mark actual overs by 2.5 total handicap 
finalbets_filtered <- finalbets_filtered[, c("home_score", "away_score") := tstrsplit(score, ":", fixed=TRUE)]
finalbets_filtered$home_score <- as.numeric(finalbets_filtered$home_score)
finalbets_filtered$away_score <- as.numeric(finalbets_filtered$away_score)

#if over 1, else 0 
finalbets_filtered[home_score+away_score > 2.5, EndResult := 1 ]
finalbets_filtered[is.na(EndResult), EndResult := 0 ]
finalbets_filtered <- finalbets_filtered[,-c("p1","probsum"), with=F]

#Home-Tie-Away Results, if home 1 if away 2 if tie 0
finalbets_filtered[home_score > away_score , HTAResult := 1 ]
finalbets_filtered[home_score < away_score , HTAResult := 2 ]
finalbets_filtered[is.na(HTAResult), HTAResult := 0 ]

finalbets_filtered <- finalbets_filtered[betType != "ah"]
```

#Task 1 a,b,c & Task 2

We have cleaned data now, for this task each bookmaker will be examined seperately.  

For PCA we need to get unique identifiers based on betType, oddtype and totalhandicap. 
The data that we will perform PCA on will have matchId's in rows, and above mentioned identifiers as feature vectors in columns. And this data set will be prepared for each bookmaker. 

But we have a problem here. There are too many betTypes, and for some betTypes like *ou* totalhandicap values create even more variety. Because of that, for each match, data table crated based on description above has many NA values on columns. PCA does not work while we have missing entires, and using only complete cases reduces the number of rows too much, that they become less than number of columns. 

To address this issue, I created a two phased solution, I will describe in detail below. 

To begin with, class values are created as follows, 

```{r create class, include=TRUE, eval=TRUE, results=FALSE}
#Combine class values 
finalbets_filtered <- finalbets_filtered[ !is.na(totalhandicap) , Class := paste0( betType, "|" , oddtype , "|" ,totalhandicap, sep = "") ]
finalbets_filtered <- finalbets_filtered[ is.na(totalhandicap) , Class := paste0( betType, "|" , oddtype , sep = "") ]
```

Then, as phase 1, number of non-NA rows are found per bookmaker per class, and per class. Detailed code can be found in *Appendix*, below is the summary of this data 

```{r bookmaker_class_agg, include = FALSE, eval= TRUE}
#At this point we calculate how many rows of data we actually have for each  "class", 
#There can be "class"es that occurs on one row only, such small data sample affect our analysis 
#since they would be outliers 
data_points_bm_cl <- finalbets_filtered[, list(Count = length(matchId)), by = c("bookmaker","Class")]
data_points_cl <- finalbets_filtered[, list(Count = length(matchId)), by = c("Class")]
```


```{r bookmaker_class_agg_summary, include=TRUE, echo=FALSE, eval = TRUE}
summary(data_points_bm_cl$Count)
summary(data_points_cl$Count)
```

The summary indicates a big difference between mean and median values. Small median and high mean indicates heavily right skewed data, and there are many rows with small number of observations. As mentioned above, this situation will cause too many NA's, therefore I removed some of the bookmaker & Class pairs and some classes. Remove decision is based on whether number of observations these pairs or individual classes have is less than some number close to median or not.

Removal code can be found in *Appendix*

```{r combine counts and eliminate, include=FALSE, eval=TRUE }

finalbets_filtered2 <- merge(finalbets_filtered, data_points_bm_cl, by.x = c("bookmaker", "Class"), by.y= c("bookmaker" ,"Class")
              , all.x = TRUE, all.y = TRUE) 
                
finalbets_filtered2 <- merge(finalbets_filtered2, data_points_cl, by.x = "Class", by.y = "Class", all.x = TRUE, all.y= TRUE)                
     finalbets_filtered2 <- finalbets_filtered2[Count.x > 500]
finalbets_filtered2 <- finalbets_filtered2[Count.y > 2500]
```

```{r new summary, include=TRUE , eval = TRUE, echo = FALSE}
summary(finalbets_filtered2$Count.x)
summary(finalbets_filtered2$Count.y)
```

New summary shows closer median and mean values, so our work here is done. 

As phase2, I will replace NA values based on a criteria. To determine the Class values that have NA values per bookmaker, I pivot data, and unpivot pivotted data. In this way, NA values are printed automatically for missing values. Details of this code can be found in *Appendix*

```{r fill NA, include=FALSE, eval = TRUE}
#pivot and melt to determine missing values 
data <- cbind(finalbets_filtered2$matchId , finalbets_filtered2$EndResult, finalbets_filtered2$HTAResult, finalbets_filtered2$probability, finalbets_filtered2$bookmaker, finalbets_filtered2$Class)
data <- as.data.table(data)
setnames(data,c("matchId", "EndResult","HTAResult","probability", "bookmaker", "Class"))
data_pivot <- dcast(data, matchId + EndResult + HTAResult + bookmaker ~ Class, value.var =  "probability")
data_melted <- melt(data_pivot, id.vars=c("matchId","EndResult","HTAResult","bookmaker")
                                           , measure.vars = c("1x2|odd1",	"1x2|odd2",	"1x2|oddX",	"bts|NO",	"bts|YES",	"dc|12",	"dc|1X",	"dc|X2",	"ha|1",	"ha|2",	"ou|over|0.5",	"ou|over|1.5",	"ou|over|2",	"ou|over|2.25",	"ou|over|2.5",	"ou|over|2.75",	"ou|over|3",	"ou|over|3.5",	"ou|over|4.5",	"ou|over|5.5",	"ou|over|6.5",	"ou|under|0.5",	"ou|under|1.5",	"ou|under|2",	"ou|under|2.25",	"ou|under|2.5",	"ou|under|2.75",	"ou|under|3",	"ou|under|3.5",	"ou|under|4.5",	"ou|under|5.5",	"ou|under|6.5"))
 
data_melted$value <- as.numeric(data_melted$value)
```

Then, I filled NA values with median of the odd probabilites of bookmakers per matchId per Class. 
This is based on the assumption that bookmakers will act similar on the same matches in terms of probability of each oddType. 
Of course, if a Class value , say "1x2|odd1" , is never played on that match, we would not be able to fill NA's

```{r replace NA, include=TRUE, eval = TRUE, results= FALSE}
data_melted[,value := ifelse(is.na(value), median(value, na.rm=TRUE), value), by= list(matchId,variable)]
```

From now on, we perform every step for each bookmaker. Code on *Appendix* provides standart form of what I have performed per bookmaker. 

For each bookmaker, data is pivotted again so that Class variables are in columns, NA's are omitted and data is standardized with scale function. Then primcomp is performed. 

```{r 10Bet , include= FALSE, eval=TRUE}
#i in 1:nrow(BookmakersSelected)
i = 1
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))
```

For 10Bet, the summary is as follows. 

These results suggests that by choosing components 1 and 2 we are explaning 75% percent of the variance. And marginal increase in information gain decreases as number of components increase. 

Eigenvectors information indicates strong negative corrolation between over and under types of bet, and also win/lose types of home tie away kind of bets. This result is parallel to our expectaitons. We also observe that some components does not use the information provided by some variables. Results also suggest strong correlation between Class variables like *ou|under|2.25* and *ou|under|2.5*

Results for other bookmakers are very similar. 

Below the summary are the color coded graphs of new coordinates per each bookmaker. We cannot really see a distinction between over/under bets. However, as we can observe, home and away points are distinuished easily from the graph. 

For each bookamaker, MDS is performed based on Eucledian and Manhattan Distances. MDS codes can be found in *Appendix*. The resulting graphs are similiar to what we have seen in PCA part. Density of the points changes, and the position of the points with "home wins" and "away wins" changes, but still, we cannot really see a distinction between over/under bets. Home and away points are distinuished easily from the graph. 

```{r load_10Bet , include=TRUE, eval=TRUE, echo = FALSE}
par(mfrow=c(1,1))
barplot(pca_prin$loadings, main = "Loadings graph for bookmaker 10Bet")
```

```{r imp_10Bet, include=TRUE, eval=TRUE, echo = FALSE }
summary(pca_prin, loadings = T)
```

Plots are as follows :

```{r plot, include=TRUE, eval= TRUE, echo=FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)
```

```{r mds , include=FALSE, eval=TRUE}
#MDS
#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)
mds_man <- cmdscale(manhattanMDS)
```

```{r euc, include=TRUE, eval=TRUE, echo=FALSE, results=TRUE }
par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)
```

```{r manh, include=TRUE, eval=TRUE, echo=FALSE, results=TRUE}

par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```



```{r bm2, include=FALSE, eval=TRUE }
#i in 1:nrow(BookmakersSelected)
i = 2
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))

#MDS

#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)
mds_man <- cmdscale(manhattanMDS)

```

```{r plotbm21, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm22, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm23, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```





```{r bm3, include=FALSE, eval=TRUE }
#i in 1:nrow(BookmakersSelected)
i = 3
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))

#MDS

#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)
mds_man <- cmdscale(manhattanMDS)

```

```{r plotbm31, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm32, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm33, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```




```{r bm4, include=FALSE, eval=TRUE }
#i in 1:nrow(BookmakersSelected)
i = 4
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))

#MDS

#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)
mds_man <- cmdscale(manhattanMDS)

```

```{r plotbm41, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm42, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm43, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```



```{r bm5, include=FALSE, eval=TRUE }
#i in 1:nrow(BookmakersSelected)
i = 5
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))

#MDS

#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)
mds_man <- cmdscale(manhattanMDS)

```

```{r plotbm51, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm52, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm53, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```



```{r bm6, include=FALSE, eval=TRUE }
#i in 1:nrow(BookmakersSelected)
i = 6
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))

#MDS

#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)
mds_man <- cmdscale(manhattanMDS)

```

```{r plotbm61, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm62, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm63, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```



```{r bm7, include=FALSE, eval=TRUE }
#i in 1:nrow(BookmakersSelected)
i = 7
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))

#MDS

#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)
mds_man <- cmdscale(manhattanMDS)

```

```{r plotbm71, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm72, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm73, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```



```{r bm8, include=FALSE, eval=TRUE }
#i in 1:nrow(BookmakersSelected)
i = 8
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))

#MDS

#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)
mds_man <- cmdscale(manhattanMDS)

```

```{r plotbm81, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm82, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```

```{r plotbm83, include=TRUE, eval= TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 , cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6)
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1, cex.main = 0.6, cex.lab = 0.6 , cex.axis = 0.6 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6, cex = 0.6)

```


#Task 3 

Detailed codes can be found in *Appendix*

###1

Picture is read as follows using jpeg package 

```{r read_img, include = TRUE, eval=TRUE , results = FALSE, message=FALSE}
require(jpeg)
img <- readJPEG("C:/Users/yasemin/Desktop/small_img.jpg")
```

Resulting image is an array with 786432 elements

###2

Printed image is : 

```{r print img, include=TRUE,eval = TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,1))
plot(0:1,0:1,type= "n" ,ann = FALSE, axes = FALSE)
rasterImage(img,0,0,1,1, interpolate = FALSE)
```


For this part I used par(mfrow=c(1,3)) function but somehow I could not manage to plot on the same row 

```{r print img all, include=TRUE,eval = TRUE, echo = FALSE, results=TRUE}
#Take reverse of each [img,,i] i in (1:3) since image is upside down otherwise. 
par(mfrow=c(1,3))

plot(0:1,0:1,type= "n" , ann = FALSE, axes = FALSE)
image(t(apply(img[,,1], 2, rev)), axes= FALSE )

plot(0:1,0:1,type= "n" , ann = FALSE, axes = FALSE)
image(t(apply(img[,,2], 2, rev)), axes = FALSE)

plot(0:1,0:1,type= "n" , ann = FALSE, axes = FALSE)
image(t(apply(img[,,3], 2, rev)), axes = FALSE)
```

Probably because of similar density of red, green and blue , all graphs look orange-ish

###3

Add noise on the image and display : 

```{r noised create, include=FALSE, eval = TRUE}
noised <- array(data=NA, dim = c(512,512,3))

noised[,,1]<-img[,,1] + matrix(runif(512*512,0,0.1),512,512)
noised[,,2]<-img[,,2] + matrix(runif(512*512,0,0.1),512,512)
noised[,,3]<-img[,,3] + matrix(runif(512*512,0,0.1),512,512)

noised[,,1][noised[,,1]>1] <- rep(1, length(noised[,,1][noised[,,1]>1])) 
noised[,,2][noised[,,2]>1] <- rep(1, length(noised[,,2][noised[,,2]>1])) 
noised[,,3][noised[,,3]>1] <- rep(1, length(noised[,,3][noised[,,3]>1])) 
```


```{r print img noised, include=TRUE,eval = TRUE, echo = FALSE, results=TRUE}
par(mfrow=c(1,1))
plot(0:1,0:1,type= "n" ,ann = FALSE, axes = FALSE)
rasterImage(noised,0,0,1,1, interpolate = FALSE)
```


```{r print img all noised, include=TRUE,eval = TRUE, echo = FALSE, results=TRUE}
#Take reverse of each [img,,i] i in (1:3) since image is upside down otherwise. 
par(mfrow=c(1,3))

plot(0:1,0:1,type= "n" , ann = FALSE, axes = FALSE)
image(t(apply(noised[,,1], 2, rev)), axes= FALSE )

plot(0:1,0:1,type= "n" , ann = FALSE, axes = FALSE)
image(t(apply(noised[,,2], 2, rev)), axes = FALSE)

plot(0:1,0:1,type= "n" , ann = FALSE, axes = FALSE)
image(t(apply(noised[,,3], 2, rev)), axes = FALSE)
```

#Appendix

Bookmaker selection :

```{r ref.label='select bookmaker', echo = TRUE, eval = FALSE, results = FALSE}
```

Converting odds to probabilities :

```{r ref.label='prob_calc' ,echo = TRUE, eval = FALSE, results = FALSE}
```

Labelling actual results as over based on total handicap 2.5 :
```{r ref.label='actual over', echo= TRUE, eval=FALSE, results= FALSE }
```

Calculating number of non_NA columns per bookmaker & Class :
```{r ref.label='bookmaker_class_agg', echo=TRUE, eval=FALSE, results=FALSE}
```

Removing belove median bookmakers & Classes : 
```{r ref.label = 'combine counts and eliminate' , echo= TRUE, eval=FALSE, results= FALSE}
```

Pivot & melt to replace NAs : 
```{r ref.label= 'fill NA', echo=TRUE, eval=FALSE}
```

PCA per bookmaker standard code : 
```{r standardized_app , include= TRUE, eval=FALSE}
#i in 1:nrow(BookmakersSelected)
i = 1
  
data_bm <- data_melted[bookmaker == BookmakersSelected[i]]
data_bm$value <- as.numeric(data_bm$value)
data_bm_pivot <- dcast(data_bm, matchId + EndResult + HTAResult ~ variable, value.var = "value")
data_bm_pivot <- na.omit(data_bm_pivot)

col <- ncol(data_bm_pivot)
row <- nrow(data_bm_pivot)

scaled_data <- matrix(data=NA, nrow = row, ncol = col)
scaled_data <- as.data.table(scaled_data)
data_bm_pivot<- as.data.table(data_bm_pivot)
scaled_data[,1:3] <- data_bm_pivot[,1:3]

colnames <- names(data_bm_pivot)

for (j in 4:col)
{
  scaled_data[,j] <- scale(data_bm_pivot[,get(colnames[j])])
  j = j+1
}

setnames(scaled_data, colnames)

pca_prin <- princomp(scaled_data[,4:ncol(scaled_data)])

color_over <- scaled_data$EndResult
color_over <- as.numeric(color_over)

color_hta <- scaled_data$HTAResult
color_hta <- as.numeric(color_hta)

legend_over <- cbind(c("Over", "Under"),c(2,1))
legend_over[,2] <- as.numeric(legend_over[,2])
legend_over <- as.data.table(legend_over)
setnames(legend_over,c("Label","Color"))

legend_HTA <- cbind(c("Home", "Away", "Tie"), c(2,3,1))
legend_HTA[,2] <- as.numeric(legend_HTA[,2])
legend_HTA <- as.data.table(legend_HTA)
setnames(legend_HTA,c("Label","Color"))


par(mfrow=c(1,2))

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " over/under 2.5"), col = color_over + 1 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.3)

plot(pca_prin$scores, main = paste0("PCA results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta + 1 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.3)
```

MDS standard code per bookmaker : 
```{r mds_app, include=TRUE, eval=FALSE, echo = TRUE}

#MDS

#Calculate distance matrices

col <- ncol(scaled_data)
euclideanMDS=dist(scaled_data[,4:col],diag= T, upper = T )
manhattanMDS=dist(scaled_data[,4:col],method = "manhattan") 

mds_euc <- cmdscale(euclideanMDS)

par(mfrow=c(1,2))

plot(mds_euc[,1], mds_euc[,2],main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6)

plot(mds_euc[,1], main = paste0("Euclidean MDS results for " , BookmakersSelected[i] , " home / away / tie"), mds_euc[,2], col = color_hta+1 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6)


mds_man <- cmdscale(manhattanMDS)

par(mfrow=c(1,2))

plot(mds_man[,1], mds_man[,2],main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " over/under 2.5"),  col = color_over+1 )
legend("topleft",unique(legend_over$Label) ,col=unique(legend_over$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6)

plot(mds_man[,1], mds_man[,2], main = paste0("Manhattan MDS results for " , BookmakersSelected[i] , " home / away / tie"), col = color_hta+1 )
legend("topleft",unique(legend_HTA$Label) ,col=unique(legend_HTA$Color) , pch = 1, bty = "o"
       , xjust =1 , yjust=1, x.intersp = 0.2,y.intersp = 0.6)

```

Draw image : 
```{r ref.label = 'print img', include=TRUE, eval=FALSE , echo=TRUE}
```

Draw image components : 
```{r ref.label = 'print img all', include=TRUE, eval=FALSE , echo=TRUE}
```

Create random noise on image :
```{r ref.label = 'noised create', include=TRUE, eval=FALSE , echo=TRUE}
```

